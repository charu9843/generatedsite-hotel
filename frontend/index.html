<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VoiceWeb Tamil</title>

  <!-- Google Identity script -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
     body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color:white;
      color: #333;
      min-height: 100vh;  /* ensures footer is at bottom */
      position: relative;

    }

    /* Header Section */
    .header {
      text-align: center;
      padding: 40px 20px;
      border-radius: 10px 10px 0 0;
    
    }
    
    .header h1 { 
      margin: 0; 
      font-size: 55px;
    /*  color:black;
      background-color:white; */
      margin-top: 40px; 
      text-align: center;
      font-weight: bold;
      letter-spacing: -7px; 
      font-family: 'Poppins', sans-serif;
    }



    /* Mic Section */
    .mic-section {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px 20px;
  
    }

    .mic-container {
      text-align: center;
      flex: 1;
    }

    .mic-btn {
      width: 160px;
      height: 160px;
      background-color: white;
      border-radius:100%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0 auto 15px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .mic-btn img {
      width: 100px;
      height: 100px;
    }

    .mic-container p {
      font-size: 16px;
      color: #537497;
      margin-top: 30px; 
    }
    .status-section {
      margin-top: 30px;
      display: none; 
    }

    .status-section h3 {
      margin-bottom: 30px;
      text-align: center;
      margin-top:-40px;
      font-size: 27px;
      color: #987167;

    }

    .progress {
      width: 250px;
      height: 25px;
      background: #ccc;
      border-radius: 15px;
      margin: 0 auto 20px;
      overflow: hidden;
    }

    .progress-bar {
      width: 0%;
      height: 100%;
      background: #4caf50;
      text-align: center;
      color: white;
      font-size: 14px;
      line-height: 25px;
    }

    .action-buttons {
      margin-top: 10px;
      text-align: center;
    }

    .action-buttons .btn {
      padding: 10px 50px;
      margin: 5px;
      background: #5a4e4e;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 17px;
      display: none;
    }

    .action-buttons .btn:hover {
      background: #3b3232;
    }
     #editor-toolbar {
      background: #222;
      color: white;
      padding: 10px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    #editor-toolbar select, 
    #editor-toolbar input, 
    #editor-toolbar button {
      margin: 5px;
      padding: 6px 12px;
      font-size: 14px;
    }
    #preview-container {
      display: none;
      margin: 0;
    }
    #preview-iframe {
      width: 100%;
      height: 90vh;
      border: none;
    }
    .btn {
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .btn:hover {
      background: #0056b3;
    }
    

    
  </style>
</head>
<body>

  <!-- Header -->
 
   <div class="header">
    <h1>
    <span style="color:#4285F4">M</span>
    <span style="color:#EA4335">i</span>
    <span style="color:#FBBC05">c</span>
    <span style="color:#4285F4">2</span>
    <span style="color:#34A853">W</span>
     <span style="color:#EA4335">e</span>
    <span style="color:#4285F4">b</span>
    
    <span style="color:#756e6e; font-size:20px;  letter-spacing:-1px; margin-left:10px;">(WIP)-This website is for a hackathon</span>

   </h1>
   
  
</div>

  <!-- Mic Section -->
  <div class="mic-section">
    <div class="mic-container">
      <div class="mic-btn" id="micBtn">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJkAAACUCAMAAAC3HHtWAAAAaVBMVEX///8dHRsAAAD///0bGxkXFxXW1tY3NzbJycckJCLd3dtBQUD8/PyDg4EMDAkgIB6xsbHs7OylpaVRUVDOzs719fQFBQCZmZlcXFzDw8NtbW1GRkYSEg91dXSPj46JiYkrKyu6urplZWNJ2HtxAAAFHklEQVR4nO2cDXOiMBCGYQmgEBPDtxL8+v8/8rJJtEr1sM4Eejd556YKLcfTzWY3YdcGgZeXl5eX138n+vzk09OzShFQsWq7Pr+pO6zE8mBK2aEHAMYkkyjGGEC+SRZnE20KMgxDzkMrfBPD6SgWY1K+RIOsh9jA3ItzTiBN8AeWUKTuW6UsfCHOTrsgWgQsioIqZmNz3aFJ2C0BpsgCUTbfR/Ierc8WQaN0Ay/BuP7X7OsFwKJgBS/NdRWcFyG7NK9HUotwVi5htCQmExbjIZGr+cGi4mXAuENrDvOHtHpgf5mXFiyUl/mHU3Ry0mYqTS0QOLI8foOMnJLZyZL0LbL1avalmiKbcLMr2dx632Zzp3VP5sk8mSfzZJ7Mk3kyT+bJPJkn82SezJN5srEiGll9QHa9zA3ZDe0Tslpd5+p51fWX/ojMyhGb2KJWH5FRfa2r+l0FqE39CVnG8FpXhaiEEx7KwTyt/hEZDRJd7XH1ANKQXX5KplVJRQauyLI1CYnsxA/J9GiemTpg7shifML/Edm2CTkhlSMygTBxmnxAFrVSXbp2VbYQqcTaw+6HZKh6QLKTI7KIllINCSv0UdbHfLogEKeVthnWgrjMXRWhog6LYLDRB+peb1QqsGCNZBlamJWOUkAUDAx7Csz//0atLtS1OjM18YDt3YApshZLmjHg5KTv1DdVbG1Nz8YBS+7N0RnZGZSZuI2XKu5OghFZmZaTEg3cbJ2RGRgYzNEAk6PJOuNZmW4G4BhvXLhaFIgeyVSsVWbA3oMpoxE4I0kUbPGXILmrcBahmfCG9n70MNUWAUONbhbVHfok2ztcORaapbG3EN1f0XijEpk2WaWNCxgIXcFlegBJaB0m0w1Lr9pcGLeZKdgYUzstqfcaBTaRQatyQNDnFjut9LSMgowQhc9Kh3uUQA0nWsjU7bGZUej+sydmi0ElSY2C/UOYx9RguiTLet2g19jlo4Lb9jAKuYqCQV7Qq1Odpe7csHnKlejGYCgD0MiE96wtcYnfMKtGHZTtl0+JUpOxI3U6mkGyRrfiMUuC6/aR1tl26Mq+L7W6fZHU1ymoXvdm1igHcLxZP2hP011v7+xsaQu6GQ3awOUuHSVOpuuGqf2AudNzPnu2MJNDprVzsmBn17Jw3/IzorsNZmtbR/nO7ZMNczccT9zfNfnrja2ZmGLDCMY7HEv3UoFir9FUkG+OmYlYT3+y3uVwzZ9zPENDU1y0Vys6FbbECzRa7bGnlZvEPsNDND1MmMo1Wijj/PgsHdLt5cSIBiOwn6lRGpMSPYTWHioNQXjcVpmojYRIzoWKvYoLPZ+z9Rw+doe35XBLRhJgnZeX/X4Y9peuTBmw214UTuc5+8/Qr7JNbNe0OsfH0iYnKb9azAnwg5i1M45SZNsNBMdsvPqxLyqqAB9cPciYAkwOJY7c4wIN3YvEDbDykC348QVRtUNO9FLDWkyvNWQ/FNVyH12wqrNkVwxlbh5zkLQcil3yOz6IYsW054M5+BVgGkIl6zjWYXVpnG+KgibGefnryJTN9Ggqmy3y2ZPXuiP7ZfJk77E8SpPh3Bx/w/Uae1pmffHdZrOTrYbNg45m4dMcH09vzrNP1gJGsuuM8enjAmT8oR7Av17vT8NhAbJny7Kx+CJkbxQqFiKLZTytBci2af6O0nZ2MpG9J+GsF8LLy8vLy8vLy8vLy8vLy8vLy8vrnxS9e0N138H4G/odvXYPjr7c3tOHi6b/BN8fOOlRJLK0VmcAAAAASUVORK5CYII=" alt="Mic">
      </div>
     
        <button id="stopBtn" style="display:none; margin-top:10px; padding:10px 20px; background:#ff3333; color:#fff; border:none; border-radius:5px; cursor:pointer;">
    Stop Mic</button>

        <div id="signinBox" style="display:none;">
  <div id="g_id_signin"></div>
</div>

      <p>Tap the microphone to initiate voice commands and effortlessly create and auto-deploy your website.</p>
    </div>
   
  </div>

  <!-- Status Section -->
     <div class="status-section">
    <h3>Website Status</h3>
    <div class="progress">
      <div class="progress-bar" id="progress-bar">0%</div>
    </div>
     <div class="action-buttons mt-4">
        <button id="view-site-btn" class="btn" onclick="showPreview()">View Website</button>
        <button id="download-btn" class="btn" onclick="downloadSite()">Download Zip</button>
      </div>
<!-- Preview Section -->
 <div id="editor-toolbar" style="display:none;">
    <select id="editor-options" onchange="handleEditorAction(this.value)">
      <option value="">-- Edit--</option>
      <option value="editText">‚úèÔ∏è Edit Text</option>
      <option value="changeBackground">üé® Change Background</option>
      <option value="replaceImage">üñºÔ∏è Replace Image</option>
    </select>

    <!-- Dropdown for choosing which image to replace -->
    <select id="image-selector" style="display:none;"></select>

    <!-- Hidden inputs -->
    <input type="color" id="bgColorPicker" style="display:none;" onchange="changeBackground(this.value)">
    <input type="file" id="imageUploader" accept="image/*" style="display:none;" onchange="replaceImage(event)">

    <!-- Action buttons -->
    <button class="btn" onclick="saveEdits()">üíæ Save</button>
    <button class="btn" onclick="deployWebsite()">üöÄ Deploy</button>
  </div>

  <!-- Website Preview -->
  <div id="preview-container">
    <iframe id="preview-iframe"></iframe>
  </div>

   



  
   
  <!-- Script -->
  <script>
    /******** DOM references ********/
    const micBtn = document.getElementById("micBtn");
    const stopBtn = document.getElementById("stopBtn");
    const signinBox = document.getElementById("signinBox");
    const progressBar = document.getElementById("progress-bar");
    const statusSection = document.querySelector(".status-section");

    /******** State ********/
    let recognition;
    let finalTamilText = "";
    let userSignedIn = false;

    /******** Helpers ********/
    function updateProgress(value, text) {
      progressBar.style.width = value + "%";
      progressBar.textContent = text || value + "%";
    }

    function showPreview() {
      const iframe = document.getElementById('preview-iframe');
      iframe.src = '/preview/index.html';
      document.getElementById('preview-container').style.display = 'block';
      document.getElementById('editor-toolbar').style.display = 'block';
      iframe.onload = () => {
        populateImageDropdown();
        disableTextEdit();
      };
    }

    // small utility functions (kept same)
    function enableTextEdit() {
      const iframeDoc = document.getElementById('preview-iframe').contentDocument;
      iframeDoc.body.contentEditable = true;
      alert("‚úèÔ∏è You can now edit text directly inside the preview.");
    }
    function disableTextEdit() {
      const iframeDoc = document.getElementById('preview-iframe').contentDocument;
      iframeDoc.body.contentEditable = false;
    }
    function changeBackground(color) {
      const iframeDoc = document.getElementById('preview-iframe').contentDocument;
      iframeDoc.body.style.backgroundColor = color;
    }
    function populateImageDropdown() {
      const iframeDoc = document.getElementById('preview-iframe').contentDocument;
      const imgs = iframeDoc.querySelectorAll("img");
      const dropdown = document.getElementById("image-selector");
      dropdown.innerHTML = "";
      if (imgs.length === 0) {
        const opt = document.createElement("option");
        opt.text = "No images found";
        opt.value = "";
        dropdown.add(opt);
        return;
      }
      imgs.forEach((img, index) => {
        const opt = document.createElement("option");
        opt.value = index;
        opt.text = `Image ${index + 1}`;
        dropdown.add(opt);
      });
    }
    function replaceImage(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const iframeDoc = document.getElementById('preview-iframe').contentDocument;
        const imgs = iframeDoc.querySelectorAll("img");
        const selectedIndex = document.getElementById('image-selector').value;
        if (selectedIndex === "") {
          alert("‚ùå Please select an image first.");
          return;
        }
        const img = imgs[selectedIndex];
        if (img) img.src = e.target.result;
        else alert("‚ùå No image found at that slot.");
      };
      reader.readAsDataURL(file);
    }
    function handleEditorAction(action) {
      if (action === "editText") enableTextEdit();
      else if (action === "changeBackground") document.getElementById("bgColorPicker").click();
      else if (action === "replaceImage") {
        document.getElementById("image-selector").style.display = "inline-block";
        document.getElementById("imageUploader").click();
      }
      document.getElementById("editor-options").value = "";
    }

    /******** Google Sign-In (renders button but keeps it hidden) ********/
    window.onload = function() {
      // replace this client_id if necessary
      google.accounts.id.initialize({
        client_id: "1041434272397-s2dh3sh4mc9f0o2njk48ktnrlo5qs05d.apps.googleusercontent.com",
        callback: handleCredentialResponse,
        auto_select: false
      });

      // Render button into the g_id_signin div inside signinBox
      google.accounts.id.renderButton(
        document.getElementById("g_id_signin"),
        { theme: "outline", size: "large" }
      );

      // keep signinBox hidden until mic click shows it
      signinBox.style.display = "none";
    };

    function handleCredentialResponse(response) {
      // user successfully signed in with Google
      console.log("‚úÖ Google login success:", response);
      userSignedIn = true;
      signinBox.style.display = "none";    // hide the google button
      startMic();                          // auto-start mic after login
    }

    /******** Speech recognition setup ********/
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'ta-IN';

      // When user clicks the mic:
      micBtn.addEventListener('click', () => {
        if (!userSignedIn) {
          // show the google sign-in button next to mic
          signinBox.style.display = "inline-block";
          return;
        }
        // already signed in ‚Üí start mic
        startMic();
      });

      // Stop button handler
      stopBtn.addEventListener('click', () => {
        recognition.stop();
        // hide stop btn ‚Äî the onend handler will proceed with processing
        stopBtn.style.display = "none";
        console.log("üõë Mic manually stopped by user");
      });

      // helper to start mic and show stop button (keeps UI similar to your original)
      function startMic() {
        try {
          recognition.start();
        } catch (e) {
          // some browsers throw if start called while already starting; ignore
          console.warn("start() call warning:", e);
        }
        stopBtn.style.display = "inline-block";
        console.log("üé§ Mic started");
        // don't display status-section yet; we'll show it after user stops
        updateProgress(10, "Listening...");
      }

      // onresult ‚Äî capture transcript (keeps same approach you used)
      recognition.onresult = (event) => {
        finalTamilText = "";
        for (let i = 0; i < event.results.length; i++) {
          finalTamilText += event.results[i][0].transcript;
        }
        // keep console debug
        console.log("‚úÖ Speech captured:", finalTamilText);
      };

      // onend ‚Äî called when recognition stops (manually or naturally)
      recognition.onend = () => {
        // if stop button still visible it means we intended to keep listening (auto-restart)
        if (stopBtn.style.display === "inline-block") {
          // restart (continuous listening behaviour)
          recognition.start();
          return;
        }

        // user actually stopped: proceed only if we have text
        if (finalTamilText.trim() === "") {
          console.log("No speech captured.");
          return;
        }

        // show status UI and run backend pipeline
        statusSection.style.display = "block";
        document.getElementById("view-site-btn").style.display = 'none';
        document.getElementById("download-btn").style.display = 'none';

        let processingTimeout = setTimeout(() => {
          updateProgress(30, "Processing...");
        }, 1500);

        // Step 1: /intent
        fetch('/intent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tamilText: finalTamilText })
        })
        .then(res => res.json())
        .then(data => {
          if (!data.success) throw new Error("Intent detection failed");
          updateProgress(50, 'Intent detected');

          processingTimeout = setTimeout(() => {
            updateProgress(60, "Processing...");
          }, 1500);

          // Step 2: /generate-code
          return fetch('/generate-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ intent: data.intent })
          });
        })
        .then(res => res.json())
        .then(data => {
          clearTimeout(processingTimeout);
          if (!data.success) throw new Error("Code generation failed");
          updateProgress(80, 'Code generated');
          document.getElementById("view-site-btn").style.display = 'inline-block';
          document.getElementById("download-btn").style.display = 'inline-block';
          updateProgress(100, 'Ready to view and download');
        })
        .catch(err => {
          console.error(err);
          updateProgress(0, 'Error');
        });
      };

      recognition.onerror = (event) => {
        console.error("Speech recognition error:", event.error);
        updateProgress(0, 'Error');
        stopBtn.style.display = "none";
      };

    } else {
      alert("Speech Recognition not supported in this browser");
    }

    /******** Save / Deploy / Download (unchanged) ********/
    function saveEdits() {
      const iframeDoc = document.getElementById('preview-iframe').contentDocument;
      const updatedHtml = iframeDoc.documentElement.outerHTML;

      fetch('/save-edits', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: 'index.html', content: updatedHtml })
      })
      .then(res => res.json())
      .then(data => alert(data.message))
      .catch(err => alert("‚ùå Error saving changes"));
    }

    async function deployWebsite() {
      try {
        disableTextEdit();

        // Save current edits first
        const iframeDoc = document.getElementById('preview-iframe').contentDocument;
        const updatedHtml = iframeDoc.documentElement.outerHTML;

        await fetch('/save-edits', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename: 'index.html', content: updatedHtml })
        });

        // Deploy saved files to Azure
        const newTab = window.open('', '_blank');
        const res = await fetch('/deploy', { method: 'POST' });
        const data = await res.json();

        if (data.message && data.url) {
          alert(`‚úÖ ${data.message}\nLive URL: ${data.url}`);
          // Open live site in new tab
          newTab.location.href = data.url;
        } else {
          alert('‚ùå Deployment failed');
        }
      } catch (err) {
        console.error(err);
        alert('‚ùå Error deploying website');
      }
    }

    function downloadSite() {
      window.location.href = '/download';
    }

    // Expose functions used in markup
    window.saveEdits = saveEdits;
    window.deployWebsite = deployWebsite;
    window.downloadSite = downloadSite;
    window.showPreview = showPreview;
    window.handleEditorAction = handleEditorAction;
    window.changeBackground = changeBackground;
    window.replaceImage = replaceImage;
  </script>
</body>
</html>
